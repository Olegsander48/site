<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- favicon -->
    <link rel="icon" type="image/svg+xml" href="/img/icons/svg/check-double-solid_dark.svg">

    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <!--<meta name="viewport" content="width=device-width, initial-scale=1">-->
    <meta name="description" content="CheckDev - пробные собеседования в IT.">
    <title>Собеседования</title>

    <!-- Required meta tags -->
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <!-- fontawesome-free-6.3.0-web -->
    <link th:href="@{/webjars/font-awesome/6.3.0/css/all.min.css}" rel="stylesheet">
    <!-- Popper.js 2.11.7 -->
    <script th:src="@{/webjars/popper.js/2.11.7/umd/popper.js}"></script>
    <!-- Jquery.js 3.7.1 -->
    <script th:src="@{/webjars/jquery/3.7.1/jquery.min.js}"></script>
    <!-- Bootstrap 5.3.2 -->
    <link th:href="@{/webjars/bootstrap/5.3.2/css/bootstrap.min.css}" rel="stylesheet">
    <script th:src="@{/webjars/bootstrap/5.3.2/js/bootstrap.min.js}"></script>

    <!-- Summernote 0.8.10 -->
    <link th:href="@{/webjars/summernote/0.8.10/summernote-lite.css}" rel="stylesheet">
    <script th:src="@{/webjars/summernote/0.8.10/summernote-lite.js}"></script>
    <script th:src="@{/webjars/summernote/0.8.10/lang/summernote-ru-RU.js}"></script>

    <script th:inline="javascript" type="text/javascript">

    var filter = /*[[${filter}]]*/ null;
    var topics = /*[[${topics}]]*/ null;
    var filterProfiles = /*[[${filterProfiles}]]*/ null;
    var userId = /*[[${userId}]]*/ 0;
    var currentCategoryId;
    var currentTopicId;
    var currentFilterProfile;
    var currentStatus;
    var currentMode;

    function init() {
        if (filter != null) {
            currentCategoryId = filter.categoryId;
            currentTopicId = filter.topicId;
            currentFilterProfile = filter.filterProfile;
            currentStatus = filter.status;
            currentMode = filter.mode;
            if (currentCategoryId > 0) {
                inflateTopicList(topics);
            }
        } else {
            currentCategoryId = 0;
            currentTopicId = 0;
            currentFilterProfile = 0;
            currentStatus = 0;
            currentMode = 0;
        }
    }

    window.onload = init;

    function onCategoryItemClick(element) {
        var id = element.getAttribute('data-id');
        var categoryName = element.getAttribute('data-name');
        userId = element.getAttribute('data-user_id');
        currentCategoryId = id;
        createFilter();
    }

    function inflateTopicList(response) {
        var s = '';
        for (var i = 0; i < response.length; i++) {
            s += '<ul value="' + response[i].id + '" ' +
                'data-id="' + response[i].id + '" ' +
                'data-name="' + response[i].name + '" ' +
                'onclick="onTopicItemClick(this)">' +
                response[i].name + '</ul>';
        }
        $('#topics_select').html(s);
    }

    function onTopicItemClick(element) {
        var topicId = element.getAttribute('data-id');
        var topicName = element.getAttribute('data-name');
        showPatch('topic_patch_div', 'topicPatchTextSpan', topicName);
        currentTopicId = topicId;
        createFilter();
    }

    function onFilterProfileItemClick(element) {
        var filterProfileId = element.getAttribute('data-id');
        var filterProfileName = element.getAttribute('data-name');
        showPatch('filterProfile_patch_div', 'filterProfilePatchTextSpan', filterProfileName);
        currentFilterProfile = filterProfileId;
        createFilter();
    }

    function onStatusItemClick(element) {
        var status = element.getAttribute('data-id');
        var statusName = element.getAttribute('data-name');
        showPatch('status_patch_div', 'statusPatchTextSpan', statusName);
        currentStatus = status;
        createFilter();
    }

    function onModeItemClick(element) {
        var mode = element.getAttribute('data-id');
        var modeName = element.getAttribute('data-name');
        showPatch('mode_patch_div', 'modePatchTextSpan', modeName);
        currentMode = mode;
        createFilter();
    }

    function onCategoryPatchCancelClick(element) {
        var container = element.parentNode;
        hideElement(container.id);
        hideElement('topic_patch_div');
        var userId = element.getAttribute('data-user_id');
        $('#topics_select').html('');
        currentTopicId = 0;
        currentCategoryId = 0;
        if (currentFilterProfile < 1 && userId > 0 && currentStatus < 1 && currentMode < 1) {
            deleteFilter(userId);
        } else {
            createFilter();
        }
    }

    function onTopicPatchCancelClick(element) {
        var container = element.parentNode;
        hideElement(container.id);
        currentTopicId = 0;
        createFilter();
    }

    function onFilterProfilePatchCancelClick(element) {
        var container = element.parentNode;
        hideElement(container.id);
        var userId = element.getAttribute('data-user_id');
        currentFilterProfile = 0;
        if (currentCategoryId < 1 && currentStatus < 1 && currentMode < 1) {
            deleteFilter(userId);
        } else {
            createFilter();
        }
    }

    function onStatusPatchCancelClick(element) {
        var container = element.parentNode;
        hideElement(container.id);
        var userId = element.getAttribute('data-user_id');
        currentStatus = 0;
        if (currentCategoryId < 1 && currentFilterProfile < 1 && currentMode < 1) {
            deleteFilter(userId);
        } else {
            createFilter();
        }
    }

    function onModePatchCancelClick(element) {
        var container = element.parentNode;
        hideElement(container.id);
        var userId = element.getAttribute('data-user_id');
        currentMode = 0;
        if (currentCategoryId < 1 && currentFilterProfile < 1) {
            deleteFilter(userId);
        } else {
            createFilter();
        }
    }

    function showPatch(elementId, textSpanId, text) {
        var element = document.getElementById(elementId);
        if (element) {
            element.style.display = "block";
            var textSpan = document.getElementById(textSpanId);
            if (textSpan) {
                textSpan.textContent = text;
            }
        }
    }

    function hideElement(elementId) {
        var element = document.getElementById(elementId);
        if (element) {
            element.style.display = "none";
        }
    }

    function createFilter() {
        var filter = {
            userId: userId,
            categoryId: currentCategoryId,
            topicId: currentTopicId,
            filterProfile: currentFilterProfile,
            status: currentStatus,
            mode: currentMode
        };
        if (userId > 0) {
            $.ajax({
                type: "POST",
                url: "/filter/create",
                data: JSON.stringify(filter),
                contentType: "application/json",
                success: function (response) {
                    console.log("filter saved.");
                    location.reload();
                }
            });
        } else {
            $.ajax({
                type: "POST",
                url: "/interviews/reload",
                data: JSON.stringify(filter),
                contentType: "application/json",
                success: function (response) {
                    console.log("filter saved.");
                    location.reload();
                }
            });
        }
    }

    function deleteFilter(userId) {
        if (userId > 0) {
            $.ajax({
                type: 'DELETE',
                url: '/filter/delete/' + userId,
                success: function (result) {
                    console.log('filter with id ' + userId + ' was deleted');
                    location.reload();
                }
            });
        } else {
            var filter = {
                userId: 0,
                categoryId: 0,
                topicId: 0,
                filterProfile: 0,
                status: 0,
                mode: 0
            };
            $.ajax({
                type: "POST",
                url: "/interviews/reload",
                data: JSON.stringify(filter),
                contentType: "application/json",
                success: function (response) {
                    location.reload();
                }
            });
        }
    }





    </script>

</head>
<body>
<div th:insert="fragments/header :: header"></div>
<div class="container">
    <div class="alert alert-info" role="alert">
        Выберите интересующее собеседование.
        Нажмите кнопку "Откликнуться". Автор получит уведомление о вашем желании пройти собеседование.
        Если он одобрит ваше заявление, то вы получите контактные данные автора
        и сможете договориться о деталях собеседования.
    </div>
    <div class="row">
        <div class="cell">
            <div class="btn-group">
                <div class="btn-group border border-start me-2">
                    <div class="dropdown" id="categories_select">
                        <button class="btn btn-light btn-sm dropdown-toggle"
                                type="button" id="dropdownMenuButton1"
                                data-bs-toggle="dropdown" aria-expanded="false">
                            Категории
                        </button>
                        <ul class="dropdown-menu" aria-labelledby="dropdownMenuButton1">
                            <li class="dropdown-item" th:each="category: ${categories}">
                                <ul onclick="onCategoryItemClick(this)"
                                    th:text="${category.name}"
                                    th:data-id="${category.id}"
                                    th:data-name="${category.name}"
                                    th:data-user_id="${userInfo != null ? userInfo.getId() : 0}">
                                </ul>
                            </li>
                        </ul>
                    </div>
                    <div th:if="${filter != null && filter.categoryId > 0}" id="category_patch_div" class="ms-1">
                        <button class="btn btn-light btn-sm" onclick="onCategoryPatchCancelClick(this)"
                                th:data-user_id="${userId}">
                            <span id="categoryPatchTextSpan" th:text="${categoryName}"></span>
                            <span class="fas fa-times"></span>
                        </button>
                    </div>
                </div>

                <div class="btn-group border border-start me-2">
                    <div class="dropdown">
                        <button class="btn btn-light btn-sm dropdown-toggle"
                                type="button" id="dropdownMenuButton2"
                                data-bs-toggle="dropdown" aria-expanded="false">
                            Темы
                        </button>
                        <ul class="dropdown-menu" aria-labelledby="dropdownMenuButton2">
                            <li class="dropdown-item" id="topics_select">
                            </li>
                        </ul>
                    </div>
                    <div th:if="${filter != null && filter.topicId > 0}" id="topic_patch_div" class="ms-1">
                        <button class="btn btn-light btn-sm" onclick="onTopicPatchCancelClick(this)"
                                th:data-user_id="${userId}">
                            <span id="topicPatchTextSpan" th:text="${topicName}"></span>
                            <span class="fas fa-times"></span>
                        </button>
                    </div>
                </div>

                <div th:if="${userId > 0}" class="btn-group border border-start me-2">
                    <div class="dropdown" id="filterProfile_select">
                        <button class="btn btn-light btn-sm dropdown-toggle"
                                type="button" id="dropdownMenuButton3"
                                data-bs-toggle="dropdown" aria-expanded="false">
                            Профиль
                        </button>
                        <ul class="dropdown-menu" aria-labelledby="dropdownMenuButton3">
                            <li class="dropdown-item" th:each="filterProfile: ${filterProfiles}">
                                <ul onclick="onFilterProfileItemClick(this)"
                                    th:text="${filterProfile.name}"
                                    th:data-id="${filterProfile.id}"
                                    th:data-name="${filterProfile.name}"
                                    th:data-user_id="${userInfo != null ? userInfo.getId() : 0}">
                                </ul>
                            </li>
                        </ul>
                    </div>
                    <div th:if="${userId > 0 && filter != null && filter.filterProfile > 0}"
                         id="filterProfile_patch_div" class="ms-1">
                        <button class="btn btn-light btn-sm" onclick="onFilterProfilePatchCancelClick(this)"
                                th:data-user_id="${userId}">
                            <span id="filterProfilePatchTextSpan" th:text="${filterProfileName}"></span>
                            <span class="fas fa-times"></span>
                        </button>
                    </div>
                </div>

                <div th:if="${userId > 0}" class="btn-group border border-start me-2">
                    <div class="dropdown" id="status_select">
                        <button class="btn btn-light btn-sm dropdown-toggle"
                                type="button" id="dropdownMenuButton4"
                                data-bs-toggle="dropdown" aria-expanded="false">
                            Статус
                        </button>
                        <ul class="dropdown-menu" aria-labelledby="dropdownMenuButton4">
                            <li class="dropdown-item" th:each="status: ${statuses}">
                                <ul onclick="onStatusItemClick(this)"
                                    th:text="${status.info}"
                                    th:data-id="${status.id}"
                                    th:data-name="${status.info}"
                                    th:data-user_id="${userInfo != null ? userInfo.getId() : 0}">
                                </ul>
                            </li>
                        </ul>
                    </div>
                    <div th:if="${filter != null && filter.status > 0}" id="status_patch_div" class="ms-1">
                        <button class="btn btn-light btn-sm" onclick="onStatusPatchCancelClick(this)"
                                th:data-user_id="${userId}">
                            <span id="statusPatchTextSpan" th:text="${statusName}"></span>
                            <span class="fas fa-times"></span>
                        </button>
                    </div>
                </div>

                <div th:if="${userId > 0}" class="btn-group border border-start me-2">
                    <div class="dropdown" id="mode_select">
                        <button class="btn btn-light btn-sm dropdown-toggle"
                                type="button" id="dropdownMenuButton5"
                                data-bs-toggle="dropdown" aria-expanded="false">
                            Роль
                        </button>
                        <ul class="dropdown-menu" aria-labelledby="dropdownMenuButton4">
                            <li class="dropdown-item" th:each="mode: ${modes}">
                                <ul onclick="onModeItemClick(this)"
                                    th:text="${mode.info}"
                                    th:data-id="${mode.id}"
                                    th:data-name="${mode.info}"
                                    th:data-user_id="${userInfo != null ? userInfo.getId() : 0}">
                                </ul>
                            </li>
                        </ul>
                    </div>
                    <div th:if="${filter != null && filter.mode > 0}" id="mode_patch_div" class="ms-1">
                        <button class="btn btn-light btn-sm" onclick="onModePatchCancelClick(this)"
                                th:data-user_id="${userId}">
                            <span id="modePatchTextSpan" th:text="${modeName}"></span>
                            <span class="fas fa-times"></span>
                        </button>
                    </div>
                </div>
<!--                <span th:if="${userInfo != null}">-->
<!--                <form th:if="${userInfo != null}" th:action="@{/interview/getVacancyLink}"-->
<!--                      method="get">-->
<!--                        <button type="submit"-->
<!--                                class="btn btn-primary align-middle d-inline-block">Сгенерировать на основе вакансии</button>-->
<!--                </form>-->
<!--                </span>-->
            </div>
        </div>
    </div>
    <div class="row">
        <div id="interviews" class="cell">
            <table class="table table-hover">
                <thead>
                <tr>
                    <th scope="col">Собеседование</th>
                    <th scope="col">Дата проведения</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="interview: ${#lists.toList(interviewsPage)}">
<span th:if="${interview.submitterId == userId || interview.submitterId != userId && STATUS_IS_CANCELED_ID != interview.statusId}">
                    <td>
                        <div>
                            <span class="fw-bold">
                                    <a class="text-decoration-none text-dark"
                                       th:href="@{|/interview/${interview.id}|}">
                                        <div th:if="${topicsLiteMap.containsKey(interview.topicId)}">
                                        <h5 th:text="${topicsLiteMap.get(interview.topicId).categoryName + ' / '
                                         + topicsLiteMap.get(interview.topicId).name}"></h5>
                                        </div>
                                    </a>
                            </span>
                            <small class="mb-2 text-muted">
                                <span th:insert="fragments/statusInterview::status"></span>
                                <i class="far fa-clock"></i>
                                <span class="me-2"
                                      th:text="${#strings.substring(interview.createDate, 0, 10)}"></span>
                                <i class="far fa-user"></i>
                                <span class="me-2"
                                      th:text="${authService.findById(interview.submitterId).username}"></span>
                                <i class="fa fa-comments" aria-hidden="true"></i>
                                <span>Откликов:</span>
                                <span th:text="${interview.countWishers}"></span>
                            </small>
                        </div>
                    </td>
                    <td>
                        <span th:text="${interview.approximateDate}"></span>
                    </td>
                    </span>
                </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>
<div>
    <nav th:if="${interviewsPage.totalPages > 1}" aria-label="Page navigation">
        <ul class="pagination pagination-sm justify-content-center">
            <li class="page-item">
                <a class="page-link" th:if="${interviewsPage.number > 0}"
                   th:href="@{/interviews/(page=${interviewsPage.number - 1})}"
                   aria-label="Previous">
                    <span aria-hidden="true">&laquo;</span>
                    <span class="sr-only">Previous</span>
                </a>
            </li>
            <li th:each="pageNumber : ${#numbers.sequence(1, interviewsPage.totalPages)}"
                th:class="${pageNumber - 1 == interviewsPage.number ? 'page-item active' : 'page-item'}">
                <a class="page-link" th:if="${interviewsPage.toList().size() > 0}"
                   th:href="@{/interviews/(page=${pageNumber - 1})}"
                   th:text="${pageNumber}"></a>
            </li>
            <li class="page-item">
                <a class="page-link" th:if="${interviewsPage.number + 1 < interviewsPage.totalPages}"
                   th:href="@{/interviews/(page=${interviewsPage.number + 1})}"
                   aria-label="Next">
                    <span aria-hidden="true">&raquo;</span>
                    <span class="sr-only">Next</span>
                </a>
            </li>
        </ul>
    </nav>
</div>
<div th:insert="fragments/footer :: footer"></div>
</body>
</html>
